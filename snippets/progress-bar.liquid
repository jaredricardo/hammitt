
{%- comment -%}
  Get GWP Tier blocks from header section
{%- endcomment -%}
{% assign gwp_tiers = section.blocks | where: 'type', 'gwp-tier' %}

{%- comment -%}
  Calculate cart total in dollars
{%- endcomment -%}
{% assign cart_total = cart.total_price | divided_by: 100.0 %}

{%- comment -%}
  Find the current tier status
{%- endcomment -%}
{% assign previous_tier = null %}
{% assign current_tier = null %}
{% assign next_tier = null %}
{% assign found_next_tier = false %}

{% for tier in gwp_tiers %}
  {% assign tier_threshold = tier.settings.gwp_tier_threshold %}
  
  {% if cart_total >= tier_threshold %}
    {% assign previous_tier = tier %}
  {% elsif found_next_tier == false %}
    {% assign next_tier = tier %}
    {% assign found_next_tier = true %}
  {% endif %}
{% endfor %}

{%- comment -%}
  Calculate progress for next tier
{%- endcomment -%}
{% assign amount_remaining = 0 %}
{% assign amount_remaining_in_cents = 0 %}
{% assign progress_percentage = 0 %}
{% assign progress_start = 0 %}

{% if next_tier %}
  {% assign next_threshold = next_tier.settings.gwp_tier_threshold %}
  
  {% if previous_tier %}
    {% assign progress_start = previous_tier.settings.gwp_tier_threshold %}
  {% endif %}
  
  {% assign tier_range = next_threshold | minus: progress_start | times: 1.0 %}
  {% assign progress_amount = cart_total | minus: progress_start %}
  {% assign progress_percentage = progress_amount | times: 100.0 | divided_by: tier_range %}
  
  {% if progress_percentage > 100 %}
    {% assign progress_percentage = 100 %}
  {% elsif progress_percentage < 0 %}
    {% assign progress_percentage = 0 %}
  {% endif %}
  
  {% assign amount_remaining = next_threshold | minus: cart_total %}
  {% assign amount_remaining_in_cents = amount_remaining | times: 100 %}
{% elsif previous_tier %}
  {% comment %} All tiers reached, set to 100% {% endcomment %}
  {% assign progress_percentage = 100 %}
{% endif %}

{%- comment -%}
  Build JSON data for GWP tier management
{%- endcomment -%}
{% capture gwp_tiers_data %}
[
  {%- for tier in gwp_tiers -%}
    {%- if tier.settings.gwp_product and tier.settings.gwp_tier_is_free_shipping == false -%}
      {%- assign first_variant = tier.settings.gwp_product.variants | first -%}
      {
        "threshold": {{ tier.settings.gwp_tier_threshold }},
        "variantId": {{ first_variant.id }},
        "productPrice": {{ tier.settings.gwp_product.price }},
        "isFreeShipping": false
      }{% unless forloop.last %},{% endunless %}
    {%- endif -%}
  {%- endfor -%}
]
{% endcapture %}

<div class="progress-bar-container {% if cart.item_count == 0 %} hidden {% endif %}" data-gwp-tiers='{{ gwp_tiers_data | strip_newlines | strip }}'>
  {%- if previous_tier -%}
    {%- comment -%} Show success message for the previous tier {%- endcomment -%}
    <div class="gwp-progress-bar-header gwp-tier-success">
      <span class="h7">
        {%- if previous_tier.settings.gwp_tier_is_free_shipping -%}
          You've received FREE shipping!
        {%- else -%}
          {{ previous_tier.settings.gwp_tier_reached_message }}
          {% if previous_tier.settings.gwp_tier_alternate_reward_title != blank %}
            {% assign reward_title = previous_tier.settings.gwp_tier_alternate_reward_title %}
          {% elsif previous_tier.settings.gwp_product %}
            {% assign reward_title = previous_tier.settings.gwp_product.title %}
          {% endif %}
          {%- if reward_title != blank -%}
            <strong>{{ reward_title }}</strong>
          {%- endif -%}
        {%- endif -%}
      </span>
    </div>
  {%- endif -%}
  
  {%- if next_tier -%}
    {%- comment -%} Show progress toward next tier {%- endcomment -%}
    <div class="gwp-progress-bar-header gwp-tier-not-reached">
      <span class="h7">
        {%- if next_tier.settings.gwp_tier_is_free_shipping -%}
          You are <strong>{{ amount_remaining_in_cents | money_without_trailing_zeros }}</strong> away from FREE shipping!
        {%- else -%}
          ADD <strong>{{ amount_remaining_in_cents | money_without_trailing_zeros }}</strong> {{ next_tier.settings.gwp_tier_not_reached_message }}
          {% if next_tier.settings.gwp_tier_alternate_reward_title != blank %}
            {% assign reward_title = next_tier.settings.gwp_tier_alternate_reward_title %}
          {% elsif next_tier.settings.gwp_product %}
            {% assign reward_title = next_tier.settings.gwp_product.title %}
          {% endif %}
          {%- if reward_title != blank -%}
            <strong>{{ reward_title }}</strong>
          {%- endif -%}
        {%- endif -%}
      </span>
    </div>
    
    <div class="progress-bar" style="--scale-x: {{ progress_percentage }}%;">
    </div>
  {%- elsif previous_tier -%}
    {%- comment -%} All tiers reached, show full progress bar {%- endcomment -%}
    <div class="progress-bar" style="--scale-x: 100%;">
    </div>
  {%- endif -%}

</div>

