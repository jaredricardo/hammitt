{% style %}

    [data-section-id="{{ section.id }}"] {
        background-color: {{ section.settings.background_color }};
    }

    html {
        scroll-behavior: smooth !important;
    }

{% endstyle %}

<div data-section-id="{{ section.id }}">
    <div class="jr-image-with-text-navigator page-width">
        <ul>
            {% for block in section.blocks %}
                <li>
                    <a href="#{{ block.settings.href }}">{{ block.settings.title }}</a>
                </li>
            {% endfor %}
        </ul>

    </div>
</div>

<script>
    window.addEventListener('DOMContentLoaded', () => {

        const links = document.querySelectorAll(`[data-section-id="{{ section.id }}"] ul li`)
        const observerSelector = "{{ section.settings.observer_class_selector }}"
        const sectionsToCheckScroll = document.querySelectorAll(`.${observerSelector}`)

        links.forEach(link => {
            link.addEventListener('click', () => {
                links.forEach((l) => {l.classList.remove('active')})
                link.classList.add('active')
            })
        })

        if(sectionsToCheckScroll.length === 0) return

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const activeLink = document.querySelector(`li:has([href="#${entry.target.id}"])`)
                    links.forEach((l) => {l.classList.remove('active')})
                    if (activeLink) {
                        activeLink.classList.add('active')
                    }
                } 
            })
        }, {
            root: null,
            threshold: 1
        })

        sectionsToCheckScroll.forEach(section => {
            observer.observe(section)
        })

    })

</script>

{% schema %}
    {
        "name": "JR Image Text Navigator",
        "limit": 1,
        "enabled_on": {
            "templates": [
                "page"
            ]
        },
        "presets": [
            {
                "name": "JR Image Text Navigator"
            }
        ],
        "settings": [
            {
                "type": "color",
                "id": "background_color",
                "label": "Background Color",
                "default": "#ffffff"
            },
            {
                "type": "text",
                "id": "observer_class_selector",
                "label": "Observer Class Selector",
                "info": "This is the class selector that should be used for the obserever to work correctly. This class is used to determine which element has been scrolled into view, then modifies the active link in the navigator based on what is in view."
            }
        ],
        "blocks": [
            {
                "type": "navigator",
                "name": "scroll to",
                "settings": [
                    {
                        "type": "text",
                        "id": "title",
                        "label": "Navigation title"
                    },
                    {

                        "type": "text",
                        "id": "href",
                        "label": "Href to scroll to"
                    }
                ]
            }
        ]
    }
{% endschema %}
